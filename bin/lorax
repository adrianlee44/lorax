#!/usr/bin/env node

/*
 * Lorax
 * https://github.com/adrianlee44/lorax
 *
 * Copyright (c) 2017 Adrian Lee
 * Licensed under the MIT license.
 */

import path from 'node:path';
import { fileURLToPath } from 'node:url';
import { readFileSync, existsSync } from 'node:fs';
import {program} from 'commander';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const dir = path.join(__dirname, '../');
const pkg = JSON.parse(readFileSync(path.join(dir, 'package.json'), 'utf8'));

program
  .name('lorax')
  .description('Generate changelog by parsing formatted git commits')
  .version(pkg.version, '-V, --version', 'display version number')
  .usage('[options]')
  .addHelpText('after', `
Examples:
  $ lorax                                   # Generate changelog for current version to changelog.md
  $ lorax -t v2.0.0                         # Generate changelog for v2.0.0 release
  $ lorax -t v1.5.0 -s v1.4.0 -f HISTORY.md # Generate changelog from v1.4.0 to v1.5.0 in HISTORY.md
  $ lorax -p -t v1.1.0                      # Prepend new changelog to existing file

Configuration:
  Create a lorax.json file in your project root to customize settings.
  See: https://github.com/adrianlee44/lorax#configurations
  `)
  .option(
    '-t, --tag <tag>',
    'tag of the upcoming release',
    pkg.version
  )
  .option(
    '-f, --file <file>',
    'output file name',
    'changelog.md'
  )
  .option(
    '-s, --since [tag]',
    'starting tag version (if not specified, uses all commits since last tag)'
  )
  .option(
    '-p, --prepend',
    'prepend changelog to existing file instead of overwriting'
  )
  .option(
    '-c, --config <file>',
    'path to configuration file',
    'lorax.json'
  )
  .parse(process.argv);

const options = program.opts();

// Validate file path
if (options.file && !path.isAbsolute(options.file)) {
  // Ensure we're working with a relative path from current directory
  options.file = path.resolve(process.cwd(), options.file);
}

// Validate config file exists if specified and not default
if (options.config !== 'lorax.json' && !existsSync(options.config)) {
  console.error(`Configuration file not found: ${options.config}`);
  process.exit(1);
}

// Show help if no arguments provided
if (!process.argv.slice(2).length) {
  program.help();
}

try {
  const { default: Lorax } = await import(path.join(dir, 'build/lorax.js'));
  const lorax = new Lorax();

  await lorax.generate(options.tag, options.file, {
    since: options.since,
    prepend: !!options.prepend,
  });
} catch (error) {
  console.error('Error generating changelog:', error.message);
  process.exit(1);
}
