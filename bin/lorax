#!/usr/bin/env node

/*
 * Lorax
 * https://github.com/adrianlee44/lorax
 *
 * Copyright (c) 2017 Adrian Lee
 * Licensed under the MIT license.
 */

import path from 'node:path';
import { fileURLToPath } from 'node:url';
import { readFileSync } from 'node:fs';
import {program} from 'commander';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const dir = path.join(__dirname, '../');
const pkg = JSON.parse(readFileSync(path.join(dir, 'package.json'), 'utf8'));

program
  .version(pkg.version)
  .usage('-t [tag] [options]')
  .option(
    '-F, --file [FILE]',
    'Name of the file to write to [changelog.md]',
    'changelog.md'
  )
  .option('-p, --prepend', 'Prepend to the file')
  .option('-s, --since [tag]', 'Starting tag version')
  .option(
    '-t, --tag [tag]',
    'Tag of the upcoming release [' + pkg.version + ']',
    pkg.version
  )
  .parse(process.argv);

if (!process.argv.slice(2).length) {
  program.help();
}

const { default: Lorax } = await import(path.join(dir, 'build/lorax.js'));
const lorax = new Lorax();

const options = program.opts();
lorax.generate(options.tag, options.file, {
  since: options.since,
  prepend: !!options.prepend,
});
